


BOF in Oracle Solaris 
==========
Information
-----
* CVE-2020-14871
* 해당 소프트웨어 : Oracle Solaris
* 해당 버젼 : Solaris 10, 11 / < 11.1 
*  취약점 유형 : BOF

Description
---
Oracle Solaris의 PAM (Pluggable Authentication Modules)모듈 라이브러리의 parse_user_name  함수에서의 취약한 입력값 검증을 이용하여 BOF를 일으키는 취약점이다.

Root Cause
---
### PAM

PAM이란 Pluggable Authentication Module로써 서비스에 대한 사용자의 사용 권한을 제어하는 모듈이다. 

PAM 모듈을 사용하면 

- 인증이 필요한 서비스가 직접 passwd 파일을 열람하지 않고 'PAM' 모듈에 사용자 인증을 요청
- PAM은 인증을 요청한 사용자의 정보를 가지고 결과를 도출해 서비스에 전달 

서비스에서 직접 인증 로직을 구현하지 않아 개발이 간소화되고 
passwd 파일 등 시스템 파일을 열람하지 않아도 된다. 
뿐만 아니라 시스템 운영자가 서비스의 인증 동작을 제어할 수 있어 안전하게 시스템을 운영할 수 있다. 

### Vulnerability
취약점은 PAM 라이브러리의 parse_user_name 함수의 부적절한 input값 인증에서 발생한다. 

#### Details 
username의 input값이 512 Byte를 넘는 경우에 취약점이 터지므로 
공격자는 512 Byte가 넘는 username input 값을 주기 위해서 keyboard-interactive method를 사용한다.
		
> PAM parse_user_name function
		
	static int
	parse_user_name(char *user_input, char **ret_username)
	{
            register char *ptr;
            register int index = 0;
            char username[PAM_MAX_RESP_SIZE];
       /* ... */

            ptr = user_input;
       /* ... */
             /*
             * username will be the first string we get from user_input
             * - we skip leading whitespaces and ignore trailing whitespaces
             */
            while (*ptr != '\0') {
                  if ((*ptr == ' ') || (*ptr == '\t'))
                               break;
                  else {
                               username[index] = *ptr;
                               index++;
                               ptr++;
                  }
            }
             /* ret_username will be freed in pam_get_user(). */
            if ((*ret_username = malloc(index + 1)) == NULL)
                  return (PAM_BUF_ERR);
            (void) strcpy(*ret_username, username);
            return (PAM_SUCCESS);
	}

- username이 PAM_MAX_RESP_SIZE인 512 Bytes보다 길어길 경우에 취약점이 터진다. 

Patch
---
20년 10월에 Oracle's quarterly Critical Patch Update를 발표 했으며 
Oracle Solaris 10, 11에 대해서만 제공했다. 

Oracle Solaris 9의 경우에는 더 이상의 지원이 없기 때문에 upgrade를 추천한다. 

Upgrade가 제한되는 상황에서는 sshd_config file의 두 항목
_ChallengeResponseAuthentication_

_KbdInteractiveAuthentication_를

no로 설정하는걸 권장하고 있다. 

POC
---
공개된 PoC는 아래와 같다. 

	$ ssh -l '' -o 'PreferredAuthentications keyboard-interactive' <~~>
	Please enter user name : A *513 
	Connection close by <~~> port 22 

- 서버가 "Authentication failed" 메시지를 리턴한다면 해당 서버는 취약한것이며 
- 서버가 username 프롬프트를 유지한다면 취약하지 않은 것이다. 


References
---
[1] [tenable- CVE-2020-14871: Critical Buffer Overflow in Oracle Solaris Exploited in the Wild as Zero-Day](https://www.tenable.com/blog/cve-2020-14871-critical-buffer-overflow-in-oracle-solaris-exploited-in-the-wild-as-zero-day)

[2] [FIREEYE-In Wild Critical Buffer Overflow Vulnerability in Solaris Can Allow Remote Takeover - CVE-2020-14781](https://www.fireeye.com/blog/threat-research/2020/11/critical-buffer-overflow-vulnerability-in-solaris-can-allow-remote-takeover.html)


